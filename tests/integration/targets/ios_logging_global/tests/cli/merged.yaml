---
- debug:
    msg:
      Start Merged integration state for ios_logging_global ansible_connection={{
      ansible_connection }}

- include_tasks: _remove_config.yaml

- block:
    - name: TEST - [merged] Apply provided configuration
      cisco.ios.ios_logging_global:
        config:
          - buffered:
              severity: notifications
              size: 5099
              xml: true
          - console:
              severity: critical
              xml: true
          - facility: local5
          - hosts:
              - hostname: 172.16.1.12
              - hostname: 172.16.1.11
                xml: true
              - hostname: 172.16.1.10
                filtered: true
                stream: 10
              - hostname: 172.16.1.13
                transport:
                  tcp:
                    port: 514
          - monitor:
              severity: warnings
          - message_counter:
              - log
              - syslog
          - trap: errors
          - userinfo: true
          - policy_firewall:
              rate_limit: 10
          - logging_on: enable
          - exception: 4099
          - dmvpn:
              rate_limit: 10
          - cns_events: warnings
        state: merged
      register: result

    - name: TEST - [merged] Assert that correct set of commands were generated
      assert:
        that:
          - "{{ merged['commands'] | symmetric_difference(result['commands']) |\
            \ length == 0 }}"

    - name: TEST - [merged] Assert that before dicts are correctly generated
      assert:
        that:
          - merged['before'] == {}

    - name: TEST - [merged] Assert that after dicts are correctly generated
      assert:
        that:
          - merged['after'][0]['buffered'] == result['after'][0]['buffered']
          - merged['after'][1]['cns_events'] == result['after'][0]['cns_events']
          - merged['after'][2]['console'] == result['after'][0]['console']
          - merged['after'][3]['dmvpn'] == result['after'][0]['dmvpn']
          - merged['after'][4]['exception'] == result['after'][0]['exception']
          - merged['after'][5]['facility'] == result['after'][0]['facility']
          - merged['after'][6]['monitor'] == result['after'][0]['monitor']
          - merged['after'][8]['trap'] == result['after'][0]['trap']
          - merged['after'][9]['userinfo'] == result['after'][0]['userinfo']
          - merged['after'][10]['policy_firewall'] == result['after'][0]['policy_firewall']

  always:
    - include_tasks: _remove_config.yaml
